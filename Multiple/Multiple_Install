#!/bin/bash

# Запрос уникального идентификатора у пользователя
read -p "Введите уникальный идентификатор (identifier): " IDENTIFIER

# Фиксированные параметры
NODE_NAME="Multiple"   # Имя контейнера
PIN="000000"           # PIN-код
STORAGE=1              # Размер хранилища (в GB)
BANDWIDTH_UPLOAD=1000  # Исходящий трафик (в Mbps)
BANDWIDTH_DOWNLOAD=1000 # Входящий трафик (в Mbps)

# Удаление существующего контейнера, если он есть
if docker ps -a --format '{{.Names}}' | grep -wq "$NODE_NAME"; then
    echo "Контейнер $NODE_NAME уже существует. Удаляем..."
    docker rm -f $NODE_NAME
fi

# Создание Dockerfile
cat << 'EOF' > Dockerfile
# Используем базовый образ Ubuntu 22.04
FROM ubuntu:22.04

# Установка необходимых пакетов
RUN sed -i 's|http://archive.ubuntu.com/ubuntu|http://mirror.yandex.ru/ubuntu|g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y wget tar libicu-dev locales && \
    apt-get clean

# Настройка локалей
RUN locale-gen en_US.UTF-8 && update-locale LANG=en_US.UTF-8

# Настройка ICU и .NET
ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=0
ENV LC_ALL=en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US.UTF-8

# Скачивание клиента Multiple (определяется автоматически)
ARG ARCH=x64
RUN mkdir -p /opt/multiple/Tracks && \
    wget -O /tmp/multiple.tar https://cdn.app.multiple.cc/client/linux/$ARCH/multipleforlinux.tar && \
    tar -xvf /tmp/multiple.tar -C /opt/multiple && \
    mv /opt/multiple/*/multiple-cli /opt/multiple/multiple-cli 2>/dev/null || true && \
    mv /opt/multiple/*/multiple-node /opt/multiple/multiple-node 2>/dev/null || true && \
    chmod -R 777 /opt/multiple && \
    chmod +x /opt/multiple/multiple-cli /opt/multiple/multiple-node

# Настройка PATH
ENV PATH="/opt/multiple:$PATH"

# Настройка приглашения bash
ENV PS1="[Multiple] \\w\\$ "

# Установка точки входа
WORKDIR /opt/multiple
ENTRYPOINT ["./multiple-node"]
EOF

# Определение архитектуры и сборка образа
ARCH=$(uname -m)
if [[ "$ARCH" == "x86_64" ]]; then
    ARCH="x64"
elif [[ "$ARCH" == "aarch64" ]]; then
    ARCH="arm64"
else
    echo "Неподдерживаемая архитектура: $ARCH"
    exit 1
fi

echo "Сборка Docker-образа..."
docker build --build-arg ARCH=$ARCH -t multiple-node .

# Запуск контейнера с именем и параметрами
echo "Запуск контейнера..."
docker run -d --name $NODE_NAME --restart always multiple-node

# Привязка учетной записи
echo "Привязка учетной записи..."
docker exec -it $NODE_NAME ./multiple-cli bind \
    --bandwidth-download $BANDWIDTH_DOWNLOAD \
    --identifier $IDENTIFIER \
    --pin $PIN \
    --storage $STORAGE \
    --bandwidth-upload $BANDWIDTH_UPLOAD

# Проверка прав доступа
echo "Проверка прав доступа:"
docker exec -it $NODE_NAME bash -c "ls -ld /opt/multiple /opt/multiple/Tracks"

# Подключение к логам контейнера (можно отключиться Ctrl+C)
echo "Запущен просмотр логов. Нажмите Ctrl+C для выхода."
docker logs -f $NODE_NAME
