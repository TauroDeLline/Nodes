#!/bin/bash

# Script to deploy the Rivalz node in a Docker container on Ubuntu 22.04

# Exit immediately if a command exits with a non-zero status
set -e

# Function to prompt for user input
prompt() {
    read -p "$1: " input
    echo "$input"
}

echo "=== Rivalz Node Deployment Script ==="

# Prompt for necessary variables
NODE_NAME="Rivalz"

# Prompt for EVM address
EVM_ADDRESS=$(prompt "Введите ваш EVM адрес, привязанный к платформе")

# Prompt for storage size in GB
STORAGE_GB=$(prompt "Введите количество GB для хранения данных")

# Define Docker image name
IMAGE_NAME="rivalz-node-image"

# Create a directory for the Docker build context
BUILD_DIR="./rivalz-node"

mkdir -p $BUILD_DIR

# Create Dockerfile
cat > $BUILD_DIR/Dockerfile <<EOF
# Use Ubuntu 22.04 as the base image
FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Update and upgrade packages
RUN apt-get update && apt-get upgrade -y

# Install curl and other dependencies
RUN apt-get install -y curl gnupg2

# Install Node.js 20.x
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
RUN apt-get install -y nodejs

# Install Rivalz Node CLI globally
RUN npm install -g rivalz-node-cli

# Create application directory
RUN mkdir -p /app

# Set working directory
WORKDIR /app

# Set environment variable for shell prompt
ENV PS1="[Rivalz] \\w\\$ "

# Expose necessary ports (adjust if needed)
EXPOSE 3000

# Start the Rivalz node
CMD ["bash", "-c", "rivalz run"]
EOF

echo "Dockerfile created successfully."

# Build the Docker image
echo "Building Docker image..."
docker build -t $IMAGE_NAME $BUILD_DIR
echo "Docker image '$IMAGE_NAME' built successfully."

# Remove any existing container with the same name
if [ "$(docker ps -aq -f name=$NODE_NAME)" ]; then
    echo "Removing existing container '$NODE_NAME'..."
    docker rm -f $NODE_NAME
fi

# Run the Docker container with specified configurations
echo "Running Docker container '$NODE_NAME'..."

docker run -d \
    --name $NODE_NAME \
    --restart unless-stopped \
    -v $BUILD_DIR/app:/app \
    -e EVM_ADDRESS=$EVM_ADDRESS \
    -e STORAGE_GB=$STORAGE_GB \
    $IMAGE_NAME

echo "Docker container '$NODE_NAME' is up and running."

echo "=== Deployment Complete ==="
echo "You can now attach to the container to complete the Rivalz node setup."
echo "Use the following command to access the container shell:"
echo "docker exec -it $NODE_NAME bash"
