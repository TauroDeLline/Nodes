#!/bin/bash

# Скрипт для автоматической установки и запуска ноды Rivalz в контейнере Docker

# Проверяем, что скрипт выполняется с правами root
if [ "$(id -u)" -ne 0 ]; then
  echo "Пожалуйста, запустите скрипт с правами root."
  exit 1
fi

# Запрос данных у пользователя
read -p "Введите ваш адрес кошелька: " WALLET_ADDRESS
read -p "Укажите объем диска для использования (в ГБ): " DISK_SIZE

# Устанавливаем имя контейнера
CONTAINER_NAME="Rivalz"

# Создаем Dockerfile
cat <<EOF > Dockerfile
FROM node:18

# Установка зависимостей
RUN apt-get update && apt-get install -y npm && npm install -g rivalz-node-cli

# Создаем рабочую директорию
WORKDIR /app

# Устанавливаем переменную окружения для приглашения PS1
ENV PS1="[$CONTAINER_NAME] \w\$ "

# Создаем файл ввода для rivalz run
RUN echo -e "$WALLET_ADDRESS\n\n$DISK_SIZE" > /app/input.txt

# Команда запуска ноды
CMD ["sh", "-c", "cat /app/input.txt | rivalz run > /app/logs/node.log 2>&1"]
EOF

# Создаем docker-compose.yml
cat <<EOF > docker-compose.yml
version: '3.8'
services:
  $CONTAINER_NAME:
    build: .
    container_name: $CONTAINER_NAME
    restart: always
    environment:
      - WALLET_ADDRESS=$WALLET_ADDRESS
      - DISK_SIZE=$DISK_SIZE
    volumes:
      - ./logs:/app/logs
EOF

# Создаем директорию для логов
mkdir -p logs

# Проверяем наличие docker-compose и устанавливаем, если отсутствует
if ! command -v docker-compose &> /dev/null; then
  echo "docker-compose не найден, устанавливаю..."
  curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  chmod +x /usr/local/bin/docker-compose
fi

# Проверяем сборку Docker Compose
echo "Проверка docker-compose.yml..."
docker-compose config
if [ $? -ne 0 ]; then
  echo "Ошибка в конфигурации docker-compose.yml. Проверьте файл."
  exit 1
fi

# Строим и запускаем контейнер
echo "Строим и запускаем контейнер..."
docker-compose up -d --build
if [ $? -ne 0 ]; then
  echo "Ошибка при запуске контейнера. Проверьте Dockerfile и конфигурацию."
  exit 1
fi

# Показать логи контейнера
sleep 5
echo "Проверка логов контейнера..."
docker logs $CONTAINER_NAME | uniq > ./logs/latest.log
echo -e "Логи контейнера обновлены. Для просмотра выполните команду:
  tail -f ./logs/latest.log"

echo -e "Для входа в контейнер выполните команду:
  docker exec -it $CONTAINER_NAME bash"

echo -e "Для проверки логов внутри контейнера выполните команду:
  tail -f /app/logs/node.log"

# Завершающее сообщение
echo -e "Скрипт завершён. Контейнер с именем $CONTAINER_NAME успешно запущен."
