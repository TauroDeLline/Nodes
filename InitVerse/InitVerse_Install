#!/usr/bin/env bash
set -e

# Check if port is free
function is_port_free() {
  local port_check="$1"
  if ss -lnt 2>/dev/null | awk '{print $4}' | grep -E ":${port_check}$" > /dev/null; then
    return 1
  else
    return 0
  fi
}

# Find a free port starting at 32672
function get_free_port() {
  local base_port=32672
  local max_offset=100
  for (( i=0; i<max_offset; i++ )); do
    local candidate=$((base_port + i))
    if is_port_free "$candidate"; then
      echo "$candidate"
      return 0
    fi
  done
  return 1
}

echo "Docker container setup for initverse mining."

read -rp "Enter miner name (e.g. Worker001): " MINER_NAME
[ -z "$MINER_NAME" ] && { echo "Error: miner name cannot be empty!"; exit 1; }

read -rp "Enter wallet address (e.g. 0x12345...): " WALLET_ADDRESS
[ -z "$WALLET_ADDRESS" ] && { echo "Error: wallet address cannot be empty!"; exit 1; }

HOST_PORT=$(get_free_port)
if [ -z "$HOST_PORT" ]; then
  echo "Error: no free port found in the range 32672-32772."
  exit 1
fi

CONTAINER_PORT=32672
echo "Selected host port: $HOST_PORT"

# Generate Dockerfile (ASCII only)
cat <<'EOF' > Dockerfile
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get upgrade -y && apt-get install -y \
    wget \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

RUN useradd -ms /bin/bash ininode
ENV PS1="(initverse) \u@\h:\w\$ "

WORKDIR /home/ininode
USER ininode

# Download iniminer (replace link if needed)
RUN wget -q https://github.com/Project-InitVerse/miner/releases/download/v1.0.0/iniminer-linux-x64 -O iniminer-linux-x64 \
    && chmod +x iniminer-linux-x64

CMD ["bash", "-c", "echo initverse container is built. Ready to run."]
EOF

# Generate docker-compose.yml (ASCII only, no version field)
cat <<EOF > docker-compose.yml
services:
  initverse:
    container_name: initverse
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${HOST_PORT}:${CONTAINER_PORT}"
    command: >
      bash -c "./iniminer-linux-x64
        --pool stratum+tcp://${WALLET_ADDRESS}.${MINER_NAME}@pool-core-testnet.inichain.com:${CONTAINER_PORT}"
EOF

echo "Building and starting the initverse container..."
docker-compose up -d

if ! docker ps --format '{{.Names}}' | grep -q "^initverse\$"; then
  echo "Error: container 'initverse' not running. Check docker-compose logs."
  exit 1
fi

echo "Container 'initverse' is running. Showing logs:"
echo "Press Ctrl+C to stop viewing logs (container will keep running)."
docker logs -f initverse
