#!/usr/bin/env bash
set -e

# Проверка свободного порта
function is_port_free() {
  local port_check=$1
  if ss -lnt 2>/dev/null | awk '{print $4}' | grep -E ":${port_check}$" > /dev/null; then
    return 1
  else
    return 0
  fi
}

# Функция поиска свободного порта, начиная с 32672
function get_free_port() {
  local base_port=32672
  local max_offset=100
  for (( i=0; i<max_offset; i++ )); do
    local candidate=$((base_port + i))
    if is_port_free "$candidate"; then
      echo "$candidate"
      return 0
    fi
  done
  return 1
}

echo "Настройка Docker-контейнера initverse для майнинга."

read -rp "Введите название майнера (пример: Worker001): " MINER_NAME
[ -z "$MINER_NAME" ] && { echo "Ошибка: название майнера не может быть пустым!"; exit 1; }

read -rp "Введите адрес кошелька (пример: 0x12345...): " WALLET_ADDRESS
[ -z "$WALLET_ADDRESS" ] && { echo "Ошибка: адрес кошелька не может быть пустым!"; exit 1; }

HOST_PORT=$(get_free_port)
if [ -z "$HOST_PORT" ]; then
  echo "Ошибка: не найден свободный порт в диапазоне 32672-32772."
  exit 1
fi
CONTAINER_PORT=32672
echo "Выбран порт $HOST_PORT на хосте."

# Генерация Dockerfile
cat <<EOF > Dockerfile
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get upgrade -y && apt-get install -y \\
    wget \\
    ca-certificates \\
    && rm -rf /var/lib/apt/lists/*

RUN useradd -ms /bin/bash ininode
ENV PS1="(initverse) \\u@\\h:\\w\\$ "

WORKDIR /home/ininode
USER ininode

# Скачиваем актуальный майнер (v1.0.0)
RUN wget -q https://github.com/Project-InitVerse/miner/releases/download/v1.0.0/iniminer-linux-x64 -O iniminer-linux-x64 \\
    && chmod +x iniminer-linux-x64

CMD ["bash", "-c", "echo initverse container is built. Ready to run."]
EOF

# Генерация docker-compose.yml (убираем version, чтобы не было ворнингов)
cat <<EOF > docker-compose.yml
services:
  initverse:
    container_name: initverse
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${HOST_PORT}:${CONTAINER_PORT}"
    # Если хотите указать определённые ядра, добавьте:
    # --cpu-devices 0 --cpu-devices 1 и т.п.
    command: >
      bash -c "./iniminer-linux-x64
        --pool stratum+tcp://${WALLET_ADDRESS}.${MINER_NAME}@pool-core-testnet.inichain.com:${CONTAINER_PORT}"
EOF

echo "Собираем и запускаем контейнер initverse..."
docker-compose up -d

if ! docker ps --format '{{.Names}}' | grep -q "^initverse\$"; then
  echo "Ошибка: контейнер initverse не запущен. Проверьте логи docker-compose."
  exit 1
fi

echo "Контейнер 'initverse' запущен. Открываем логи:"
echo "Нажмите Ctrl+C, чтобы выйти из просмотра (контейнер продолжит работу)."
docker logs -f initverse
