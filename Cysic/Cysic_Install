#!/usr/bin/env bash
set -e

# Цвета для вывода
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

# Проверка существующего контейнера
if docker ps -a --format '{{.Names}}' | grep -q '^Cysic$'; then
    echo -e "${YELLOW}Контейнер 'Cysic' уже существует. Удалить его для замены? (y/n)${NC}"
    read REMOVE_EXISTING
    if [[ "$REMOVE_EXISTING" =~ ^[yY]$ ]]; then
        echo -e "${GREEN}Останавливаем и удаляем старый контейнер...${NC}"
        docker stop Cysic && docker rm Cysic
    else
        echo -e "${RED}Замена отменена. Скрипт завершён.${NC}"
        exit 0
    fi
fi

# Создаём или используем существующий файл конфигурации
CONFIG_FILE="cysic.env"
if [[ -f "$CONFIG_FILE" ]]; then
    echo -e "${GREEN}Используем существующий файл конфигурации $CONFIG_FILE${NC}"
else
    echo -e "${YELLOW}Создаём новый файл конфигурации...${NC}"
    read -p "Введите ваш reward address (0x...): " REWARD_ADDRESS
    echo "REWARD_ADDRESS=$REWARD_ADDRESS" > "$CONFIG_FILE"
    echo -e "${GREEN}Файл конфигурации $CONFIG_FILE создан.${NC}"
fi

# Создаём Dockerfile.cysic
echo -e "${GREEN}Создаём Dockerfile.cysic...${NC}"
cat <<EOF > Dockerfile.cysic
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y curl wget nano ca-certificates net-tools iproute2 procps && apt-get clean

WORKDIR /app

# Добавляем файл конфигурации
COPY cysic.env /app/cysic.env

# Скрипт запуска
RUN echo '#!/bin/bash' > /app/start_node.sh && \
    echo 'source /app/cysic.env' >> /app/start_node.sh && \
    echo 'curl -L https://github.com/cysic-labs/phase2_libs/releases/download/v1.0.0/setup_linux.sh > /app/setup_linux.sh' >> /app/start_node.sh && \
    echo 'bash /app/setup_linux.sh \$REWARD_ADDRESS' >> /app/start_node.sh && \
    echo 'if [ ! -d /app/cysic-verifier ]; then echo "Ошибка: директория /app/cysic-verifier не была создана."; exit 1; fi' >> /app/start_node.sh && \
    echo 'cd /app/cysic-verifier && bash start.sh' >> /app/start_node.sh && \
    chmod +x /app/start_node.sh

CMD ["/bin/bash", "/app/start_node.sh"]
EOF

# Сборка Docker-образа
echo -e "${GREEN}Собираем Docker-образ 'cysic:latest'...${NC}"
docker build -f Dockerfile.cysic -t cysic:latest .

# Запуск контейнера
echo -e "${GREEN}Запускаем контейнер 'Cysic'...${NC}"
docker run -d --name Cysic --restart unless-stopped -v "$(pwd)/$CONFIG_FILE:/app/cysic.env" cysic:latest

echo -e "${GREEN}Контейнер 'Cysic' успешно запущен.${NC}"
echo -e "${GREEN}Просмотрите логи с помощью: docker logs -f Cysic${NC}"
