#!/usr/bin/env bash
set -e

# Цвета для вывода
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

# Определяем текущую директорию
SCRIPT_DIR=$(pwd)
echo -e "${GREEN}Запуск скрипта в директории: ${SCRIPT_DIR}${NC}"

# Проверяем наличие контейнера Cysic
CONTAINER_NAME="Cysic"
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo -e "${YELLOW}Контейнер ${CONTAINER_NAME} уже существует. Удалить его? (y/n)${NC}"
    read REMOVE_EXISTING
    if [[ "$REMOVE_EXISTING" =~ ^[yY]$ ]]; then
        echo "Останавливаем и удаляем старый контейнер ${CONTAINER_NAME}..."
        docker stop ${CONTAINER_NAME} || true
        docker rm ${CONTAINER_NAME}
        echo -e "${GREEN}Старый контейнер ${CONTAINER_NAME} удалён.${NC}"
    else
        echo -e "${YELLOW}Отмена операции.${NC}"
        exit 0
    fi
fi

# Запрашиваем reward address
echo -e "${YELLOW}Введите ваш reward address (формат 0x...):${NC}"
read REWARD_ADDRESS
if [[ ! $REWARD_ADDRESS =~ ^0x[0-9a-fA-F]{40}$ ]]; then
    echo -e "${YELLOW}Адрес имеет неверный формат.${NC}"
    exit 1
fi

# Создаём Dockerfile.cysic
DOCKERFILE_PATH="${SCRIPT_DIR}/Dockerfile.cysic"
echo -e "${GREEN}Создаём Dockerfile.cysic...${NC}"
cat <<EOF > "$DOCKERFILE_PATH"
FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive

# Установка необходимых зависимостей
RUN apt-get update && apt-get install -y curl wget nano ca-certificates net-tools iproute2 procps && apt-get clean && rm -rf /var/lib/apt/lists/*

# Установка и настройка Cysic
WORKDIR /root
RUN curl -L https://github.com/cysic-labs/phase2_libs/releases/download/v1.0.0/setup_linux.sh > /root/setup_linux.sh && \
    chmod +x /root/setup_linux.sh && \
    /root/setup_linux.sh REWARD_ADDRESS_PLACEHOLDER

# Логи и автозапуск процесса
WORKDIR /app
RUN touch /app/node.log && chmod 666 /app/node.log
CMD ["bash", "-c", "cd /root/cysic-verifier && bash start.sh >> /app/node.log 2>&1"]
EOF

# Замена placeholder на реальный адрес
sed -i "s/REWARD_ADDRESS_PLACEHOLDER/${REWARD_ADDRESS}/g" "$DOCKERFILE_PATH"

# Собираем Docker образ
echo -e "${GREEN}Собираем Docker образ 'cysic:latest' из Dockerfile.cysic...${NC}"
docker build -f Dockerfile.cysic -t cysic:latest "$SCRIPT_DIR"

# Запускаем контейнер
echo -e "${GREEN}Запускаем контейнер ${CONTAINER_NAME}...${NC}"
docker run -d --name ${CONTAINER_NAME} --restart always cysic:latest

# Проверяем состояние контейнера
echo -e "${GREEN}Проверяем состояние контейнера...${NC}"
docker ps -a
echo "Ждём 10 секунд для инициализации контейнера..."
sleep 10

# Проверяем логи
echo -e "${GREEN}Проверяем логи контейнера...${NC}"
docker logs -f ${CONTAINER_NAME}
