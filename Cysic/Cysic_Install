#!/usr/bin/env bash
set -e

# Цвета для вывода
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

# Проверка и удаление существующего контейнера
if docker ps -a --format '{{.Names}}' | grep -q '^Cysic$'; then
    echo -e "${YELLOW}Контейнер 'Cysic' уже существует. Удалить его для замены? (y/n)${NC}"
    read REMOVE_EXISTING
    if [[ "$REMOVE_EXISTING" =~ ^[yY]$ ]]; then
        echo "Останавливаем и удаляем старый контейнер..."
        docker stop Cysic && docker rm Cysic
    else
        echo -e "${YELLOW}Замена отменена. Скрипт завершён.${NC}"
        exit 0
    fi
fi

# Создание или использование существующего файла конфигурации
CONFIG_FILE="cysic.env"
if [[ -f "$CONFIG_FILE" ]]; then
    echo -e "${GREEN}Используем существующий файл конфигурации $CONFIG_FILE${NC}"
else
    echo -e "${YELLOW}Создаём новый файл конфигурации...${NC}"
    read -p "Введите ваш reward address (0x...): " REWARD_ADDRESS
    echo "REWARD_ADDRESS=$REWARD_ADDRESS" > "$CONFIG_FILE"
    echo -e "${GREEN}Файл конфигурации $CONFIG_FILE создан.${NC}"
fi

# Создаём Dockerfile
cat <<EOF > Dockerfile.cysic
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y curl wget nano ca-certificates net-tools iproute2 procps supervisor && apt-get clean

# Создаём директории
RUN mkdir -p /var/log/supervisor /app

# Добавляем конфигурации
COPY cysic.env /app/cysic.env
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Скрипт запуска ноды
RUN echo '#!/bin/bash' > /app/start_node.sh && \
    echo 'source /app/cysic.env' >> /app/start_node.sh && \
    echo 'curl -L https://github.com/cysic-labs/phase2_libs/releases/download/v1.0.0/setup_linux.sh > /app/setup_linux.sh && bash /app/setup_linux.sh $REWARD_ADDRESS' >> /app/start_node.sh && \
    echo 'cd /app/cysic-verifier && bash start.sh' >> /app/start_node.sh && \
    chmod +x /app/start_node.sh

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
EOF

# Создаём конфигурацию supervisord
cat <<EOF > supervisord.conf
[supervisord]
nodaemon=true

[program:cysic_node]
command=/app/start_node.sh
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/cysic_node.err.log
stdout_logfile=/var/log/supervisor/cysic_node.out.log
EOF

# Сборка Docker-образа
echo -e "${GREEN}Собираем Docker-образ 'cysic:latest'...${NC}"
docker build -t cysic:latest .

# Запуск нового контейнера
echo -e "${GREEN}Запускаем контейнер 'Cysic'...${NC}"
docker run -d --name Cysic --restart unless-stopped -v "$(pwd)/$CONFIG_FILE:/app/cysic.env" cysic:latest

echo -e "${GREEN}Контейнер 'Cysic' успешно запущен.${NC}"
echo -e "${GREEN}Просмотрите логи с помощью: docker logs -f Cysic${NC}"
