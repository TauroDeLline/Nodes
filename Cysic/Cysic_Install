#!/usr/bin/env bash
set -e

# Цвета для вывода
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

# Имя контейнера и образа
CONTAINER_NAME="Cysic"
IMAGE_NAME="cysic:latest"

# Проверяем и удаляем существующий контейнер
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo -e "${YELLOW}Контейнер ${CONTAINER_NAME} уже существует. Удаляем...${NC}"
    docker stop ${CONTAINER_NAME} || true
    docker rm ${CONTAINER_NAME} || true
    echo -e "${GREEN}Старый контейнер ${CONTAINER_NAME} удалён.${NC}"
fi

# Запрашиваем reward address
echo -e "${YELLOW}Введите ваш reward address (0x...):${NC}"
read REWARD_ADDRESS
if [[ ! $REWARD_ADDRESS =~ ^0x[0-9a-fA-F]{40}$ ]]; then
    echo -e "${RED}Адрес имеет неверный формат. Проверьте и попробуйте снова.${NC}"
    exit 1
fi

# Проверяем наличие файла ключа
KEY_FILE="${REWARD_ADDRESS}.key"
if [[ -f "$KEY_FILE" ]]; then
    echo -e "${GREEN}Файл ключа найден: $KEY_FILE${NC}"
else
    echo -e "${RED}Файл ключа $KEY_FILE не найден. Проверьте путь и попробуйте снова.${NC}"
    exit 1
fi

# Создаём Dockerfile
DOCKERFILE_PATH="./Dockerfile.cysic"
echo -e "${GREEN}Создаём Dockerfile ${DOCKERFILE_PATH}...${NC}"
cat <<EOF > "${DOCKERFILE_PATH}"
FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive

# Установка необходимых зависимостей
RUN apt-get update && apt-get install -y curl wget nano ca-certificates net-tools iproute2 procps && apt-get clean && rm -rf /var/lib/apt/lists/*

# Рабочая директория
WORKDIR /app

# Создаём скрипт запуска
RUN echo '#!/bin/bash' > /app/start_node.sh && \
    echo 'REWARD_ADDRESS=${REWARD_ADDRESS}' >> /app/start_node.sh && \
    echo 'curl -L https://github.com/cysic-labs/phase2_libs/releases/download/v1.0.0/setup_linux.sh > /app/setup_linux.sh' >> /app/start_node.sh && \
    echo 'bash /app/setup_linux.sh \$REWARD_ADDRESS' >> /app/start_node.sh && \
    echo 'if [ ! -d /root/cysic-verifier ]; then echo "Ошибка: директория /root/cysic-verifier не создана." >> /app/node.log; exit 1; fi' >> /app/start_node.sh && \
    echo 'cd /root/cysic-verifier && bash start.sh >> /app/node.log 2>&1' >> /app/start_node.sh && \
    echo 'tail -f /app/node.log' >> /app/start_node.sh && \
    chmod +x /app/start_node.sh

# Автозапуск через CMD
CMD ["/bin/bash", "/app/start_node.sh"]
EOF

# Сборка Docker-образа
echo -e "${GREEN}Собираем Docker-образ '${IMAGE_NAME}'...${NC}"
docker build -f "${DOCKERFILE_PATH}" -t ${IMAGE_NAME} .

# Запуск контейнера
echo -e "${GREEN}Запускаем контейнер '${CONTAINER_NAME}'...${NC}"
docker run -d --name ${CONTAINER_NAME} --restart unless-stopped ${IMAGE_NAME}

# Копируем файл ключа в контейнер
echo -e "${GREEN}Копируем файл ключа в контейнер...${NC}"
docker cp "${KEY_FILE}" "${CONTAINER_NAME}:/root/.cysic/keys/${KEY_FILE}"

# Проверяем наличие файла ключа в контейнере
echo -e "${GREEN}Проверяем файл ключа в контейнере...${NC}"
docker exec ${CONTAINER_NAME} ls -l /root/.cysic/keys/

echo -e "${GREEN}Контейнер '${CONTAINER_NAME}' успешно запущен.${NC}"
echo -e "${GREEN}Просмотрите логи с помощью: docker logs -f ${CONTAINER_NAME}${NC}"
