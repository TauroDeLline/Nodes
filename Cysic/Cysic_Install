#!/bin/bash
set -e

# Проверка наличия контейнера
CONTAINER_NAME="Cysic"
REWARD_ADDRESS="0xCA67E6E03E1AE5296366082C3D68DF1d26945551"
KEY_FILE="${REWARD_ADDRESS}.key"

if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "Контейнер ${CONTAINER_NAME} уже существует. Удаляем..."
    docker stop ${CONTAINER_NAME} || true
    docker rm ${CONTAINER_NAME} || true
    echo "Старый контейнер удалён."
fi

# Создание Dockerfile
cat > Dockerfile.cysic <<EOF
FROM ubuntu:22.04

RUN apt-get update && apt-get install -y curl wget nano ca-certificates net-tools iproute2 procps && apt-get clean
WORKDIR /app
CMD ["tail", "-f", "/dev/null"]
EOF

echo "Собираем Docker-образ..."
docker build -t cysic:latest -f Dockerfile.cysic .

echo "Запускаем контейнер ${CONTAINER_NAME}..."
docker run -d --name ${CONTAINER_NAME} --restart unless-stopped cysic:latest

echo "Ожидание 10 секунд для инициализации контейнера..."
sleep 10

# Убедитесь, что папка для ключа создана
docker exec ${CONTAINER_NAME} bash -c "mkdir -p /root/.cysic/keys"

# Копирование ключа в контейнер
if [[ -f "${KEY_FILE}" ]]; then
    echo "Копируем файл ключа в контейнер..."
    docker cp "${KEY_FILE}" "${CONTAINER_NAME}:/root/.cysic/keys/"
    echo "Файл ключа успешно скопирован."
else
    echo "Ошибка: файл ключа ${KEY_FILE} не найден!"
    exit 1
fi

# Проверка содержимого ключа в контейнере
docker exec ${CONTAINER_NAME} ls -l /root/.cysic/keys/
docker exec ${CONTAINER_NAME} sha256sum /root/.cysic/keys/${KEY_FILE}

echo "Контейнер ${CONTAINER_NAME} успешно запущен. Просмотрите логи с помощью: docker logs -f ${CONTAINER_NAME}"
