#!/bin/bash

# Цвета текста
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # Сброс цвета

# Функция проверки доступности порта
find_free_port() {
    local port=$1
    while lsof -i:$port > /dev/null 2>&1; do
        ((port++))
    done
    echo $port
}

# Имя контейнера
CONTAINER_NAME="sonaric"

# Проверка существующего контейнера
if [ $(docker ps -a --filter "name=^/$CONTAINER_NAME$" --format '{{.Names}}') ]; then
    read -p "Контейнер $CONTAINER_NAME уже существует. Удалить его? (y/n): " REMOVE_CONTAINER
    if [[ $REMOVE_CONTAINER == "y" || $REMOVE_CONTAINER == "Y" ]]; then
        echo -e "${YELLOW}Удаляем существующий контейнер...${NC}"
        docker rm -f $CONTAINER_NAME
    else
        echo -e "${RED}Операция прервана. Удалите контейнер вручную и повторите попытку.${NC}"
        exit 1
    fi
fi

# Запрос имени ноды и пароля
read -p "Введите имя ноды: " NODE_NAME
while [ -z "$NODE_NAME" ]; do
    echo -e "${RED}Имя ноды не может быть пустым. Попробуйте снова.${NC}"
    read -p "Введите имя ноды: " NODE_NAME
done

read -sp "Введите пароль для ключей: " NODE_PASSWORD
echo
read -sp "Повторите пароль: " CONFIRM_PASSWORD
echo
while [ "$NODE_PASSWORD" != "$CONFIRM_PASSWORD" ]; do
    echo -e "${RED}Пароли не совпадают. Попробуйте снова.${NC}"
    read -sp "Введите пароль для ключей: " NODE_PASSWORD
    echo
    read -sp "Повторите пароль: " CONFIRM_PASSWORD
    echo
done

DEFAULT_PORT=8080
NODE_PORT=$(find_free_port $DEFAULT_PORT)

# Создание Dockerfile
cat > Dockerfile <<EOL
FROM ubuntu:22.04

# Установка зависимостей
ENV DEBIAN_FRONTEND=noninteractive
ENV TERM=dumb
RUN apt-get update && \
    apt-get install -y tzdata curl git jq build-essential gcc unzip wget lz4 expect && \
    ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime && \
    dpkg-reconfigure --frontend noninteractive tzdata && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Копируем установочный скрипт
WORKDIR /root
COPY install.sh /root/install.sh
COPY automation.exp /root/automation.exp

# Установка Sonaric через Expect
RUN chmod +x /root/install.sh /root/automation.exp && \
    script -q -c "/usr/bin/expect /root/automation.exp" /dev/null

# Установка переменной окружения для порта
ENV NODE_PORT=8080

# Открытие порта
EXPOSE 8080

# Команда запуска ноды
CMD ["sonaric", "start"]
EOL

# Скачиваем установочный скрипт
curl -fsSL http://get.sonaric.xyz/scripts/install.sh -o install.sh

# Создаем Expect-скрипт для автоматизации ввода
cat > automation.exp <<EOL
#!/usr/bin/expect -f
set timeout -1
spawn bash /root/install.sh
expect {
    "Введите имя ноды:" {
        send "$NODE_NAME\r"
    }
    timeout {
        puts "Ошибка: Не удалось получить запрос на ввод имени ноды."
        exit 1
    }
}
expect {
    "Создать файл с ключами? (y/n):" {
        send "y\r"
    }
    timeout {
        puts "Ошибка: Не удалось получить запрос на создание ключей."
        exit 1
    }
}
expect {
    "Введите пароль:" {
        send "$NODE_PASSWORD\r"
    }
    timeout {
        puts "Ошибка: Не удалось получить запрос на ввод пароля."
        exit 1
    }
}
expect {
    "Повторите пароль:" {
        send "$NODE_PASSWORD\r"
    }
    timeout {
        puts "Ошибка: Не удалось получить запрос на повтор пароля."
        exit 1
    }
}
expect eof
EOL

# Создание docker-compose.yml
cat > docker-compose.yml <<EOL
version: '3.8'
services:
  sonaric:
    build: .
    container_name: sonaric
    ports:
      - "$NODE_PORT:8080"
    environment:
      - NODE_PORT=$NODE_PORT
    restart: unless-stopped
EOL

# Сборка контейнера
echo -e "${BLUE}Собираем Docker-образ...${NC}"
docker-compose build

# Запуск контейнера
echo -e "${BLUE}Запускаем контейнер...${NC}"
docker-compose up -d

# Проверка состояния контейнера
if [ $? -eq 0 ]; then
    echo -e "${GREEN}Контейнер $CONTAINER_NAME успешно запущен на порту $NODE_PORT!${NC}"
    echo -e "${YELLOW}Просмотр логов: docker logs -f $CONTAINER_NAME${NC}"
    echo -e "${YELLOW}Проверка состояния: docker exec -it $CONTAINER_NAME sonaric node-info${NC}"
else
    echo -e "${RED}Ошибка при запуске контейнера.${NC}"
    exit 1
fi

# Просмотр логов
read -p "Хотите посмотреть логи контейнера? (y/n): " VIEW_LOGS
if [[ $VIEW_LOGS == "y" || $VIEW_LOGS == "Y" ]]; then
    docker logs -f $CONTAINER_NAME
fi
