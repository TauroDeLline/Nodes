#!/bin/bash

# Установка зависимостей
apt-get update && apt-get install -y wget tar curl sudo docker.io

# Скачиваем и распаковываем файлы
mkdir -p /root/network3
cd /root/network3
wget https://network3.io/ubuntu-node-v2.1.0.tar
tar -xvf ubuntu-node-v2.1.0.tar
rm -f ubuntu-node-v2.1.0.tar

# Создаём Dockerfile
cat <<EOF > Dockerfile
FROM ubuntu:22.04

RUN apt-get update && apt-get install -y bash tar curl sudo
WORKDIR /network3

COPY ubuntu-node /network3/ubuntu-node

CMD ["bash", "/network3/ubuntu-node/manager.sh", "up"]
EOF

# Собираем Docker-образ
docker build -t network3 .

# Запускаем контейнер
docker run -d --name Network3 -p 8080:8080 network3

# Ожидаем запуска ноды
sleep 10

# Получаем ключ API и ссылку из логов
API_KEY=\$(docker logs Network3 2>/dev/null | grep -oP 'API Key: \\K.*')
NODE_LINK=\$(docker logs Network3 2>/dev/null | grep -oP 'https://.*:8080')

# Выводим API Key и ссылку
echo "API Key: \$API_KEY"
echo "Node Link: \$NODE_LINK"

# Инструкция по дальнейшей работе
echo -e "\\nДля просмотра логов выполните: docker logs -f Network3"
